<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N-backË™≤È°åÁ∑¥Áøí„Ç¢„Éó„É™ Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-600: #4F46E5;
            --primary-700: #4338CA;
            --primary-500: #6366F1;
            --primary-400: #818CF8;
            --primary-50: #EEF2FF;
            
            --success-600: #059669;
            --success-700: #047857;
            --success-500: #10B981;
            --success-50: #ECFDF5;
            
            --error-600: #DC2626;
            --error-700: #B91C1C;
            --error-500: #EF4444;
            --error-50: #FEF2F2;
            
            --warning-600: #D97706;
            --warning-700: #B45309;
            --warning-500: #F59E0B;
            --warning-50: #FFFBEB;
            
            --gray-900: #111827;
            --gray-800: #1F2937;
            --gray-700: #374151;
            --gray-600: #4B5563;
            --gray-500: #6B7280;
            --gray-400: #9CA3AF;
            --gray-300: #D1D5DB;
            --gray-200: #E5E7EB;
            --gray-100: #F3F4F6;
            --gray-50: #F9FAFB;
            
            --white: #FFFFFF;
            --black: #000000;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --shadow-2xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            
            --border-radius-sm: 6px;
            --border-radius: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
            --border-radius-xl: 20px;
            --border-radius-2xl: 24px;
            
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-smooth: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 500ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--gray-900) 0%, var(--gray-800) 50%, var(--primary-900) 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            color: var(--gray-900);
            font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ */
        body.dark-mode {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #2a2a3a 100%);
        }

        body.dark-mode .container {
            background: #1e1e1e;
            color: #e0e0e0;
            border-color: rgba(255, 255, 255, 0.1);
        }

        body.dark-mode h1 {
            color: #ffffff;
        }

        body.dark-mode .subtitle {
            color: #a0a0a0;
        }

        body.dark-mode .setting-group {
            background: #2a2a2a;
            border-color: #3a3a3a;
        }

        body.dark-mode .setting-label {
            color: #b0b0b0;
        }

        body.dark-mode .setting-button {
            background: #2a2a2a;
            color: #e0e0e0;
            border-color: #3a3a3a;
        }

        body.dark-mode .setting-button.active {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-500));
            color: var(--white);
        }

        body.dark-mode .stat-card.score {
            background: linear-gradient(135deg, #4F46E5, #4338CA);
        }

        body.dark-mode .stat-card.correct {
            background: linear-gradient(135deg, #059669, #047857);
        }

        body.dark-mode .stat-card.accuracy {
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
        }

        body.dark-mode .game-area {
            background: linear-gradient(135deg, #2a2a2a, #1e1e1e);
            border-color: #3a3a3a;
        }

        body.dark-mode .game-area.example {
            background: linear-gradient(135deg, #3a3520, #2a2510);
            border-color: var(--warning-600);
        }

        body.dark-mode .instruction-card {
            background: linear-gradient(135deg, #3a3520, #2a2510);
            border-color: var(--warning-600);
        }

        body.dark-mode .instruction-title,
        body.dark-mode .instruction-subtitle {
            color: #e0e0e0;
        }

        body.dark-mode .start-message {
            color: #808080;
        }

        body.dark-mode .trial-info {
            background: rgba(30, 30, 30, 0.95);
            color: #e0e0e0;
            border-color: rgba(79, 70, 229, 0.3);
        }

        body.dark-mode .example-explanation {
            background: rgba(30, 30, 30, 0.98);
            border-color: var(--warning-500);
        }

        body.dark-mode .example-explanation #example-text {
            color: #e0e0e0;
        }

        body.dark-mode .hint-area {
            background: rgba(30, 30, 30, 0.95);
            border-color: var(--warning-500);
        }

        body.dark-mode .hint-label {
            color: #a0a0a0;
        }

        body.dark-mode .hint-letter {
            color: #ffffff;
        }

        body.dark-mode .answer-button {
            background: #2a2a2a;
            color: #e0e0e0;
            border-color: #e0e0e0;
        }

        body.dark-mode .answer-button.showing-feedback {
            background: #2a2a2a !important;
            color: #e0e0e0 !important;
            border-color: #e0e0e0 !important;
        }

        body.dark-mode .control-button {
            background: #2a2a2a;
            color: #e0e0e0;
            border-color: #e0e0e0;
        }

        body.dark-mode .instructions-card {
            background: #2a2a2a;
            border-color: #3a3a3a;
        }

        body.dark-mode .instructions-card h4 {
            color: #e0e0e0;
        }

        body.dark-mode .instructions-card li {
            color: #b0b0b0;
        }

        body.dark-mode .modal-overlay {
            background: rgba(0, 0, 0, 0.85);
        }

        body.dark-mode .modal-content {
            background: #1e1e1e;
            color: #e0e0e0;
        }

        body.dark-mode .modal-content h4 {
            color: #e0e0e0;
        }

        body.dark-mode .tutorial-button {
            background: #2a2a2a;
            border-color: var(--primary-500);
            color: var(--primary-400);
        }

        body.dark-mode .result-stats {
            background: linear-gradient(135deg, #2a2a3a, #1e1e1e);
            border-color: var(--primary-500);
        }

        body.dark-mode .result-screen h2 {
            color: #ffffff;
        }

        body.dark-mode .result-score,
        body.dark-mode .result-accuracy,
        body.dark-mode .result-points {
            color: #e0e0e0;
        }

        body.dark-mode .letter {
            background: linear-gradient(135deg, #ffffff, #e0e0e0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* „ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÊôÇ„ÅÆË®≠ÂÆö„É¢„Éº„ÉÄ„É´Áî®„Çπ„Çø„Ç§„É´ */
        body.dark-mode #settings-modal .modal-content > div > div {
            background: #2a2a2a !important;
            border-color: #3a3a3a !important;
        }

        body.dark-mode #settings-modal .modal-content > div > div > div > div:first-child {
            color: #e0e0e0 !important;
        }

        body.dark-mode #settings-modal .modal-content > div > div > div > div:last-child {
            color: #a0a0a0 !important;
        }
        
        .container {
            background: var(--white);
            border-radius: var(--border-radius-2xl);
            box-shadow: var(--shadow-2xl);
            padding: 48px;
            max-width: 900px;
            width: 100%;
            position: relative;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-600), var(--primary-500));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            letter-spacing: -0.025em;
        }
        
        .subtitle {
            color: var(--gray-600);
            font-size: 1.125rem;
            font-weight: 500;
        }
        
        .instruction-card {
            background: linear-gradient(135deg, var(--warning-50), #FEF7CD);
            border: 2px solid var(--warning-500);
            border-radius: var(--border-radius-lg);
            padding: 32px;
            margin-bottom: 32px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .instruction-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--warning-500), var(--warning-600));
        }
        
        .instruction-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 12px;
            line-height: 1.2;
        }
        
        .instruction-subtitle {
            font-size: 1.25rem;
            color: var(--gray-700);
            font-weight: 500;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
            align-items: end;
        }
        
        .setting-group {
            background: var(--gray-50);
            border-radius: var(--border-radius-lg);
            padding: 24px;
            border: 1px solid var(--gray-200);
        }
        
        .setting-label {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 16px;
            display: block;
        }
        
        .button-group {
            display: flex;
            gap: 8px;
        }
        
        .setting-button {
            flex: 1;
            min-height: 44px;
            padding: 8px 4px;
            border-radius: var(--border-radius);
            border: 2px solid var(--gray-200);
            background: var(--white);
            color: var(--gray-700);
            font-weight: 600;
            font-size: 0.85rem;
            line-height: 1.3;
            cursor: pointer;
            transition: none;
            position: relative;
            overflow: hidden;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .setting-button small {
            font-size: 0.68rem;
            font-weight: 400;
            color: var(--gray-500);
            display: block;
            margin-top: 2px;
        }
        
        .setting-button.active {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-500));
            border-color: var(--primary-600);
            color: var(--white);
            box-shadow: var(--shadow-md);
        }

        .setting-button.active small {
            color: rgba(255, 255, 255, 0.8);
        }

        .setting-button:active:not(:disabled) {
            opacity: 0.8;
        }

        .setting-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            padding: 24px;
            border-radius: var(--border-radius-lg);
            text-align: center;
            color: var(--white);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card.score {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
        }
        
        .stat-card.correct {
            background: linear-gradient(135deg, var(--success-600), var(--success-700));
        }
        
        .stat-card.accuracy {
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 8px;
            line-height: 1;
        }
        
        .stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .game-area {
            background: linear-gradient(135deg, var(--gray-50), var(--white));
            border-radius: var(--border-radius-xl);
            height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-bottom: 32px;
            border: 2px solid var(--gray-100);
            overflow: hidden;
        }
        
        .game-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, rgba(79, 70, 229, 0.05), transparent 70%);
            pointer-events: none;
            transition: background var(--transition-smooth);
        }

        .game-area.example {
            background: linear-gradient(135deg, #FEF7CD, #FFF4A3);
            border: 3px solid var(--warning-500);
        }

        .game-area.example::before {
            background: radial-gradient(circle at center, rgba(234, 179, 8, 0.15), transparent 70%);
        }
        
        .letter {
            font-size: 200px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-600), var(--primary-500));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            animation: letterAppear 2s ease-in-out forwards;
        }
        
        @keyframes letterAppear {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }
            12.5% {
                transform: scale(1);
                opacity: 1;
            }
            87.5% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(0.3);
                opacity: 0;
            }
        }
        
        .feedback {
            font-size: 3.5rem;
            font-weight: 800;
            animation: feedbackBounce var(--transition-smooth) ease-out;
        }
        
        @keyframes feedbackBounce {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .feedback.correct {
            background: linear-gradient(135deg, var(--success-600), var(--success-500));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .feedback.incorrect {
            background: linear-gradient(135deg, var(--error-600), var(--error-500));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .start-message {
            font-size: 1.5rem;
            color: var(--gray-500);
            text-align: center;
            font-weight: 500;
            max-width: 400px;
            line-height: 1.5;
        }
        
        .trial-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: var(--border-radius-lg);
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-700);
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(79, 70, 229, 0.1);
        }

        .example-explanation {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            padding: 16px 28px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            border: 3px solid var(--warning-500);
            max-width: 90%;
            text-align: center;
        }

        .example-explanation #example-text {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-800);
            line-height: 1.5;
        }

        .hint-area {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 16px 24px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            border: 2px solid var(--warning-500);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .hint-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            font-weight: 600;
        }

        .hint-letter {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--warning-600), var(--warning-500));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        
        .controls {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 40px;
        }
        
        .control-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px 32px;
            border: 2px solid var(--gray-900);
            border-radius: var(--border-radius-lg);
            background: var(--white);
            color: var(--gray-900);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: none;
            position: relative;
            overflow: hidden;
            min-width: 140px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .control-button:active {
            opacity: 0.8;
        }
        
        .control-button:disabled {
            background: var(--gray-300);
            color: var(--gray-500);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .answer-area {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 32px;
            padding: 20px 0;
            position: relative;
        }
        
        .answer-buttons {
            display: flex;
            gap: 32px;
            width: 100%;
            max-width: 800px;
        }

        .answer-button-wrapper {
            flex: 1;
            position: relative;
        }
        
        .answer-button {
            width: 100%;
            padding: 48px 64px;
            border: 3px solid var(--gray-900);
            border-radius: var(--border-radius-xl);
            background: var(--white);
            color: var(--gray-900);
            font-size: 8rem;
            font-weight: 700;
            cursor: pointer;
            transition: none;
            position: relative;
            overflow: hidden;
            min-width: 280px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }

        .answer-button:active:not(:disabled) {
            opacity: 0.7;
            transform: scale(0.98);
        }
        
        .answer-button:disabled {
            background: transparent;
            color: transparent;
            border-color: transparent;
            cursor: default;
            box-shadow: none;
            transform: none;
        }
        
        .answer-button.paused {
            background: linear-gradient(135deg, var(--gray-400), var(--gray-500)) !important;
            color: var(--white) !important;
            cursor: not-allowed !important;
            transform: none !important;
        }

        .answer-button.showing-feedback {
            background: var(--white) !important;
            color: var(--gray-900) !important;
            border-color: var(--gray-900) !important;
            cursor: not-allowed !important;
            outline: none !important;
        }

        .answer-button:focus {
            outline: none !important;
        }

        .judgment-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 10;
        }

        .judgment-result {
            font-weight: 900;
            animation: judgmentAppear 0.3s ease-out;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            line-height: 1;
        }

        .judgment-result.correct {
            color: var(--success-600);
            font-size: 16rem;
        }

        .judgment-result.incorrect {
            color: var(--error-600);
            font-size: 22rem;
            position: relative;
            top: -0.1em;
        }

        @keyframes judgmentAppear {
            0% {
                transform: scale(0.9);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .instructions-card {
            background: var(--gray-50);
            border-radius: var(--border-radius-lg);
            padding: 24px;
            border: 1px solid var(--gray-200);
        }
        
        .instructions-card h4 {
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--gray-900);
            font-size: 1.125rem;
        }
        
        .instructions-card ul {
            list-style: none;
            space: 8px;
        }
        
        .instructions-card li {
            margin-bottom: 8px;
            color: var(--gray-700);
            font-weight: 500;
            position: relative;
            padding-left: 24px;
        }
        
        .instructions-card li::before {
            content: '‚Ä¢';
            position: absolute;
            left: 0;
            color: var(--primary-600);
            font-weight: bold;
            font-size: 1.2em;
        }

        #level-text,
        #level-text2 {
            color: var(--error-600);
            font-weight: 700;
        }

        .result-screen {
            text-align: center;
        }
        
        .result-screen h2 {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-600), var(--primary-500));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 32px;
            animation: resultAppear var(--transition-slow) ease-out;
        }
        
        @keyframes resultAppear {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .result-stats {
            background: linear-gradient(135deg, var(--primary-50), var(--white));
            border-radius: var(--border-radius-xl);
            padding: 48px;
            margin-bottom: 32px;
            border: 2px solid var(--primary-100);
            position: relative;
            overflow: hidden;
        }
        
        .result-stats::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-500), var(--primary-600));
        }
        
        .result-score {
            font-size: 4rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-600), var(--primary-500));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 16px;
            line-height: 1;
        }
        
        .result-accuracy {
            font-size: 1.5rem;
            color: var(--gray-700);
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .result-points {
            font-size: 1.25rem;
            color: var(--gray-600);
            font-weight: 500;
        }
        
        .result-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        
        .highlight {
            color: var(--error-600);
            font-weight: 700;
        }
        
        .hidden {
            display: none;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            padding-top: 80px;
        }

        .modal-content {
            background: var(--white);
            border-radius: var(--border-radius-xl);
            padding: 32px;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: var(--shadow-2xl);
        }

        .modal-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--error-600);
            color: var(--white);
            border: none;
            border-radius: 8px;
            width: 48px;
            height: 48px;
            cursor: pointer;
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            pointer-events: auto;
        }

        .modal-close:hover {
            background: var(--error-700);
        }

        .modal-close:active {
            background: var(--error-800);
            transform: scale(0.95);
        }

        .tutorial-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--primary-50);
            border: 2px solid var(--primary-500);
            border-radius: var(--border-radius);
            color: var(--primary-700);
            font-weight: 600;
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .tutorial-button:hover {
            background: var(--primary-100);
        }

        #sound-toggle:checked + span {
            background-color: var(--success-600);
        }

        #sound-toggle:checked + span + span {
            transform: translateX(26px);
        }

        #dark-mode-toggle:checked + span {
            background-color: var(--primary-600);
        }

        #dark-mode-toggle:checked + span + span {
            transform: translateX(26px);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 8px;
            }

            .container {
                padding: 16px;
                margin: 0;
                border-radius: var(--border-radius-lg);
            }

            .header {
                margin-bottom: 16px;
            }

            h1 {
                font-size: 1.5rem;
                margin-bottom: 4px;
            }

            .subtitle {
                font-size: 0.85rem;
            }

            /* Ë®≠ÂÆö„Ç®„É™„Ç¢„Çí„Ç≥„É≥„Éë„ÇØ„Éà„Å´ */
            .settings-grid {
                grid-template-columns: 1fr;
                gap: 12px;
                margin-bottom: 16px;
            }

            .setting-group {
                padding: 16px;
            }

            .setting-label {
                font-size: 0.9rem;
                margin-bottom: 12px;
            }

            .setting-button {
                min-height: 40px;
                font-size: 0.75rem;
            }

            .setting-button small {
                font-size: 0.6rem;
            }

            /* Áµ±Ë®à„Ç´„Éº„Éâ„ÇíÊ®™1Âàó„Å´ÂúßÁ∏Æ */
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                margin-bottom: 16px;
            }

            .stat-card {
                padding: 12px 8px;
            }

            .stat-value {
                font-size: 1.3rem;
                margin-bottom: 4px;
            }

            .stat-label {
                font-size: 0.65rem;
            }

            /* „Ç≤„Éº„É†„Ç®„É™„Ç¢„ÇíÂ§ßÂπÖ„Å´Á∏ÆÂ∞è */
            .game-area {
                height: 280px;
                margin-bottom: 16px;
            }

            .letter {
                font-size: 100px;
            }

            .start-message {
                font-size: 1rem;
                padding: 0 16px;
            }

            .trial-info {
                top: 12px;
                right: 12px;
                padding: 8px 14px;
                font-size: 0.9rem;
            }

            .example-explanation {
                top: 10px;
                padding: 10px 16px;
                max-width: 95%;
            }

            .example-explanation #example-text {
                font-size: 0.85rem;
            }

            /* Ë™¨Êòé„Ç´„Éº„Éâ„Çí„Ç≥„É≥„Éë„ÇØ„Éà„Å´ */
            .instruction-card {
                padding: 16px;
                margin: 12px 0;
            }

            .instruction-title {
                font-size: 1.2rem;
                margin-bottom: 6px;
            }

            /* ÂõûÁ≠î„Éú„Çø„É≥„ÇíÊ®™‰∏¶„Å≥„Å´‰øù„Å§„Åå„Ç≥„É≥„Éë„ÇØ„ÉàÂåñ */
            .answer-area {
                margin-bottom: 16px;
                padding: 12px 0;
            }

            .answer-buttons {
                gap: 12px;
            }

            .answer-button {
                padding: 32px 20px;
                min-width: 0;
                font-size: 5rem;
            }

            .judgment-result.correct {
                font-size: 10rem;
            }

            .judgment-result.incorrect {
                font-size: 14rem;
            }

            .hint-area {
                bottom: 10px;
                padding: 10px 16px;
            }

            .hint-label {
                font-size: 0.75rem;
            }

            .hint-letter {
                font-size: 2rem;
            }

            /* „Ç≥„É≥„Éà„É≠„Éº„É´„Éú„Çø„É≥ */
            .controls {
                gap: 10px;
                margin-bottom: 16px;
            }

            .control-button {
                min-width: 100px;
                padding: 10px 20px;
                font-size: 0.9rem;
            }

            /* „É´„Éº„É´Ë™¨Êòé„Éú„Çø„É≥ */
            .tutorial-button {
                padding: 10px 18px;
                font-size: 0.9rem;
            }

            /* „É¢„Éº„ÉÄ„É´„ÅÆ„ÇØ„É≠„Éº„Ç∫„Éú„Çø„É≥ */
            .modal-overlay {
                padding-top: 60px;
            }

            .modal-content {
                padding: 24px 16px;
                max-height: 85vh;
            }

            .modal-content h4 {
                font-size: 1.1rem;
            }

            /* ÁµêÊûúÁîªÈù¢ */
            .result-screen h2 {
                font-size: 2rem;
                margin-bottom: 20px;
            }

            .result-stats {
                padding: 32px 20px;
                margin-bottom: 20px;
            }

            .result-score {
                font-size: 2.5rem;
            }

            .result-accuracy {
                font-size: 1.2rem;
            }

            .result-points {
                font-size: 1rem;
            }
        }

        /* Performance optimizations */
        .judgment-result {
            will-change: transform, opacity;
        }
        
        /* Focus states for accessibility */
        .setting-button:focus,
        .control-button:focus {
            outline: 2px solid var(--primary-500);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="game-screen">
            <div class="header">
                <h1>N-backË™≤È°å</h1>
                <p class="subtitle">Ë®òÊÜ∂Âäõ„Å®„ÉØ„Éº„Ç≠„É≥„Ç∞„É°„É¢„É™„Éº„ÇíÈçõ„Åà„ÇãË™çÁü•„Éà„É¨„Éº„Éã„É≥„Ç∞</p>
            </div>

            <div style="position: relative; margin-bottom: 24px;">
                <div style="text-align: center;">
                    <button type="button" class="tutorial-button" onclick="openTutorial()">
                        üìñ „É´„Éº„É´Ë™¨Êòé„ÇíË¶ã„Çã
                    </button>
                </div>
                <button type="button" onclick="openSettings()" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); background: var(--gray-100); border: 2px solid var(--gray-300); border-radius: 50%; width: 48px; height: 48px; cursor: pointer; font-size: 1.3rem; display: flex; align-items: center; justify-content: center; transition: background var(--transition-fast);" onmouseover="this.style.background='var(--gray-200)'" onmouseout="this.style.background='var(--gray-100)'">‚öôÔ∏è</button>
            </div>

            <div id="tutorial-modal" class="modal-overlay" style="display: none;" onclick="if(event.target.id === 'tutorial-modal') closeTutorial()">
                <div class="modal-content">
                    <h4>üìñ N-backË™≤È°å„Å®„ÅØÔºü</h4>
                    <p style="margin-bottom: 16px; color: var(--gray-700); line-height: 1.6;">
                        ÊñáÂ≠ó„ÅåÊ¨°„ÄÖ„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ<strong>‰ªä„ÅÆÊñáÂ≠ó„Åå„ÄÅ<span id="level-text">1</span>ÂÄãÂâç„ÅÆÊñáÂ≠ó„Å®Âêå„Åò„Åã„Å©„ÅÜ„Åã</strong>„ÇíÂà§ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                    </p>

                    <div id="level-example-container"></div>

                    <h4 style="margin-top: 20px;">üéÆ ÈÅä„Å≥Êñπ</h4>
                    <ul style="list-style: none; padding-left: 0;">
                        <li style="margin-bottom: 8px;">‚Ä¢ ÊñáÂ≠ó„Åå<span id="level-text2">1</span>ÂÄãÂâç„Å®<strong>Âêå„Åò</strong>„Å™„Çâ„Äå„Äá„Äç„ÇíÊäº„Åô</li>
                        <li style="margin-bottom: 8px;">‚Ä¢ ÊñáÂ≠ó„Åå<span id="level-text3">1</span>ÂÄãÂâç„Å®<strong>ÈÅï„ÅÜ</strong>„Å™„Çâ„Äå√ó„Äç„ÇíÊäº„Åô</li>
                        <li>‚Ä¢ üí° „Ç≥„ÉÑ: ÊñáÂ≠ó„ÇíÂ£∞„Å´Âá∫„Åó„Å¶Ë¶ö„Åà„ÄÅ„É™„Ç∫„É†„Çà„ÅèÁ≠î„Åà„Åæ„Åó„Çá„ÅÜ</li>
                    </ul>

                    <div style="text-align: center; margin-top: 24px;">
                        <button type="button" class="modal-close" onclick="closeTutorial()" style="position: relative; top: auto; right: auto; width: 200px; height: 56px; font-size: 1.1rem;">Èñâ„Åò„Çã</button>
                    </div>
                </div>
            </div>

            <div id="settings-modal" class="modal-overlay" style="display: none;" onclick="if(event.target.id === 'settings-modal') closeSettings()">
                <div class="modal-content" style="max-width: 400px;">
                    <h4>‚öôÔ∏è Ë®≠ÂÆö</h4>

                    <div style="margin: 24px 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--gray-50); border-radius: var(--border-radius); border: 1px solid var(--gray-200); margin-bottom: 16px;">
                            <div>
                                <div style="font-weight: 600; color: var(--gray-900); margin-bottom: 4px;">ÂäπÊûúÈü≥</div>
                                <div style="font-size: 0.875rem; color: var(--gray-600);">Ê≠£Ëß£„Éª‰∏çÊ≠£Ëß£ÊôÇ„ÅÆÈü≥</div>
                            </div>
                            <label style="position: relative; display: inline-block; width: 60px; height: 34px;">
                                <input type="checkbox" id="sound-toggle" style="opacity: 0; width: 0; height: 0;">
                                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--gray-300); transition: .4s; border-radius: 34px;"></span>
                                <span style="position: absolute; cursor: pointer; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;"></span>
                            </label>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--gray-50); border-radius: var(--border-radius); border: 1px solid var(--gray-200);">
                            <div>
                                <div style="font-weight: 600; color: var(--gray-900); margin-bottom: 4px;">„ÉÄ„Éº„ÇØ„É¢„Éº„Éâ</div>
                                <div style="font-size: 0.875rem; color: var(--gray-600);">Êöó„ÅÑÁîªÈù¢„ÅßË°®Á§∫</div>
                            </div>
                            <label style="position: relative; display: inline-block; width: 60px; height: 34px;">
                                <input type="checkbox" id="dark-mode-toggle" style="opacity: 0; width: 0; height: 0;">
                                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--gray-300); transition: .4s; border-radius: 34px;"></span>
                                <span style="position: absolute; cursor: pointer; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;"></span>
                            </label>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 24px;">
                        <button type="button" class="modal-close" onclick="closeSettings()" style="position: relative; top: auto; right: auto; width: 200px; height: 56px; font-size: 1.1rem;">Èñâ„Åò„Çã</button>
                    </div>
                </div>
            </div>

            <div class="settings-grid">
                <div class="setting-group">
                    <label class="setting-label">Èõ£ÊòìÂ∫¶</label>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 4px;">
                        <div style="text-align: center; font-size: 0.65rem; color: var(--gray-500); font-weight: 500;">Âπï‰∏ã„Åæ„Åß</div>
                        <div style="text-align: center; font-size: 0.65rem; color: var(--gray-500); font-weight: 500;">ÂçÅ‰∏°</div>
                        <div style="text-align: center; font-size: 0.65rem; color: var(--gray-500); font-weight: 500;">Ê®™Á∂±</div>
                        <div style="text-align: center; font-size: 0.65rem; color: var(--gray-500);"></div>
                    </div>
                    <div class="button-group">
                        <button class="setting-button active" data-level="1">„Åã„Çì„Åü„Çì<br><small>Ôºà1„Å§ÂâçÔºâ</small></button>
                        <button class="setting-button" data-level="2">„Åµ„Å§„ÅÜ<br><small>Ôºà2„Å§ÂâçÔºâ</small></button>
                        <button class="setting-button" data-level="3" style="font-size: 0.75rem;">„ÇÄ„Åö„Åã„Åó„ÅÑ<br><small>Ôºà3„Å§ÂâçÔºâ</small></button>
                        <button class="setting-button" data-level="4">ÊøÄ„É†„Ç∫<br><small>Ôºà4„Å§ÂâçÔºâ</small></button>
                    </div>
                </div>

                <div class="setting-group">
                    <label class="setting-label">Ë°®Á§∫ÈÄüÂ∫¶</label>
                    <div style="height: 14px; margin-bottom: 4px;"></div>
                    <div class="button-group">
                        <button class="setting-button active" data-time="2000">„ÇÜ„Å£„Åè„Çä<br><small>Ôºà„Åã„Çì„Åü„ÇìÔºâ</small></button>
                        <button class="setting-button" data-time="1500">„Åµ„Å§„ÅÜ<br><small>Ôºà1.5ÁßíÔºâ</small></button>
                        <button class="setting-button" data-time="1000">ÈÄü„ÅÑ<br><small>Ôºà„ÇÄ„Åö„Åã„Åó„ÅÑÔºâ</small></button>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card score">
                    <div class="stat-value" id="score">0</div>
                    <div class="stat-label">„Çπ„Ç≥„Ç¢</div>
                </div>
                <div class="stat-card correct">
                    <div class="stat-value" id="correct-count">0</div>
                    <div class="stat-label">Ê≠£Ëß£Êï∞</div>
                </div>
                <div class="stat-card accuracy">
                    <div class="stat-value" id="accuracy">0.0%</div>
                    <div class="stat-label">Ê≠£Á≠îÁéá</div>
                </div>
            </div>

            <div id="game-area" class="game-area">
                <div id="letter" class="letter hidden"></div>
                <div id="feedback" class="feedback hidden"></div>
                <div id="start-message" class="start-message">ÈñãÂßã„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶ËÑ≥„Éà„É¨„ÇíÂßã„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ</div>
                <div id="trial-info" class="trial-info hidden"></div>
                <div id="hint-area" class="hint-area hidden">
                    <div id="hint-label" class="hint-label"></div>
                    <div id="hint-letter" class="hint-letter"></div>
                </div>
            </div>

            <div class="instruction-card" style="margin: 16px 0;">
                <div class="instruction-title">
                    <span id="instruction-text"><span class="highlight">1„Å§Ââç</span>„Å®Âêå„Åò„Å™„Çâ„Äá„ÄÅÁï∞„Å™„Çå„Å∞√ó</span>
                </div>
            </div>

            <div class="answer-area">
                <div class="answer-buttons">
                    <div class="answer-button-wrapper">
                        <button id="same-button" class="answer-button same" disabled>„Äá</button>
                        <div id="same-judgment" class="judgment-overlay hidden">
                            <div class="judgment-result"></div>
                        </div>
                    </div>
                    <div class="answer-button-wrapper">
                        <button id="different-button" class="answer-button different" disabled>√ó</button>
                        <div id="different-judgment" class="judgment-overlay hidden">
                            <div class="judgment-result"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="controls">
                <button id="hint-button" class="control-button hint-button hidden">Á≠î„Åà„ÇíË°®Á§∫„Åô„Çã</button>
                <button id="start-button" class="control-button start">
                    <span>‚ñ∂</span>
                    <span>ÈñãÂßã</span>
                </button>
                <button id="reset-button" class="control-button reset">
                    <span>üîÑ</span>
                    <span>„É™„Çª„ÉÉ„Éà</span>
                </button>
            </div>
        </div>
        
        <div id="result-screen" class="result-screen hidden">
            <h2>ÁµêÊûúÁô∫Ë°®</h2>
            <div class="result-stats">
                <div class="result-score" id="result-score">0/10ÂïèÊ≠£Ëß£</div>
                <div class="result-accuracy" id="result-accuracy">Ê≠£Á≠îÁéá: 0.0%</div>
                <div class="result-points" id="result-points">„Çπ„Ç≥„Ç¢: 0ÁÇπ</div>
            </div>
            <div class="result-buttons">
                <button id="replay-button" class="control-button start">
                    <span>‚ñ∂</span>
                    <span>„ÇÇ„ÅÜ‰∏ÄÂ∫¶<br>„Éó„É¨„Ç§</span>
                </button>
                <button id="menu-button" class="control-button reset">
                    <span>üìã</span>
                    <span>„É°„Éã„É•„Éº„Å´Êàª„Çã</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // „É¢„Éº„ÉÄ„É´Âà∂Âæ°Áî®„Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞
        function openTutorial() {
            document.getElementById('tutorial-modal').style.display = 'flex';
        }

        function closeTutorial() {
            document.getElementById('tutorial-modal').style.display = 'none';
        }

        function openSettings() {
            document.getElementById('settings-modal').style.display = 'flex';
        }

        function closeSettings() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        class NBackGame {
            constructor() {
                this.isPlaying = false;
                this.isPaused = false;
                this.level = 1;
                this.letterDisplayTime = 2000;
                this.currentTrial = 0;
                this.currentLetter = '';
                this.showLetter = false;
                this.letters = [];
                this.score = 0;
                this.correctCount = 0;
                this.totalAnswered = 0;
                this.feedback = '';
                this.showResult = false;
                this.canAnswer = false;
                this.showHint = false;
                this.lastAnsweredButton = null;
                this.lastAnswerCorrect = null;

                this.timerRef = null;
                this.hideTimerRef = null;
                this.animationEndHandler = null;

                this.hiragana = ['„ÅÇ', '„ÅÑ', '„ÅÜ', '„Åà', '„Åä', '„Åã', '„Åç', '„Åè', '„Åë', '„Åì', '„Åï', '„Åó'];

                // Audio Context for sound effects
                this.audioContext = null;
                this.soundEnabled = localStorage.getItem('nback-sound-enabled') !== 'false';
                this.soundsPreloaded = false;

                this.initializeElements();
                this.setupEventListeners();
                this.preloadSounds();
                this.updateDisplay();
            }

            preloadSounds() {
                // ÂäπÊûúÈü≥„Çí‰∫ãÂâçÁîüÊàê„Åó„Å¶„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÂêë‰∏ä
                try {
                    if (!this.audioContext) {
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }
                    this.soundsPreloaded = true;
                } catch (e) {
                    this.soundEnabled = false;
                }
            }

            playSound(isCorrect) {
                if (!this.soundEnabled || !this.soundsPreloaded) return;

                try {
                    if (isCorrect) {
                        // „Éî„É≥„Éù„Éº„É≥Èü≥Ôºà„Éâ‚Üí„ÉüÔºâ
                        const osc1 = this.audioContext.createOscillator();
                        const gain1 = this.audioContext.createGain();
                        osc1.connect(gain1);
                        gain1.connect(this.audioContext.destination);
                        osc1.frequency.value = 523; // C5Ôºà„ÉâÔºâ
                        osc1.type = 'sine';
                        gain1.gain.setValueAtTime(0.2, this.audioContext.currentTime);
                        gain1.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.15);
                        osc1.start();
                        osc1.stop(this.audioContext.currentTime + 0.15);

                        const osc2 = this.audioContext.createOscillator();
                        const gain2 = this.audioContext.createGain();
                        osc2.connect(gain2);
                        gain2.connect(this.audioContext.destination);
                        osc2.frequency.value = 659; // E5Ôºà„ÉüÔºâ
                        osc2.type = 'sine';
                        gain2.gain.setValueAtTime(0.2, this.audioContext.currentTime + 0.1);
                        gain2.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.3);
                        osc2.start(this.audioContext.currentTime + 0.1);
                        osc2.stop(this.audioContext.currentTime + 0.3);
                    } else {
                        // „Éñ„Éñ„ÉºÈü≥Ôºà‰ΩéÈü≥Ôºâ
                        const osc = this.audioContext.createOscillator();
                        const gain = this.audioContext.createGain();
                        osc.connect(gain);
                        gain.connect(this.audioContext.destination);
                        osc.frequency.setValueAtTime(200, this.audioContext.currentTime);
                        osc.frequency.linearRampToValueAtTime(150, this.audioContext.currentTime + 0.3);
                        osc.type = 'sawtooth';
                        gain.gain.setValueAtTime(0.15, this.audioContext.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.3);
                        osc.start();
                        osc.stop(this.audioContext.currentTime + 0.3);
                    }
                } catch (e) {
                    // Audio error - disable sound
                    this.soundEnabled = false;
                }
            }
            
            initializeElements() {
                this.elements = {
                    gameScreen: document.getElementById('game-screen'),
                    resultScreen: document.getElementById('result-screen'),
                    instructionText: document.getElementById('instruction-text'),
                    levelButtons: document.querySelectorAll('button[data-level]'),
                    timeButtons: document.querySelectorAll('button[data-time]'),
                    soundToggle: document.getElementById('sound-toggle'),
                    darkModeToggle: document.getElementById('dark-mode-toggle'),
                    score: document.getElementById('score'),
                    correctCount: document.getElementById('correct-count'),
                    accuracy: document.getElementById('accuracy'),
                    gameArea: document.getElementById('game-area'),
                    letter: document.getElementById('letter'),
                    feedback: document.getElementById('feedback'),
                    startMessage: document.getElementById('start-message'),
                    trialInfo: document.getElementById('trial-info'),
                    hintArea: document.getElementById('hint-area'),
                    hintLabel: document.getElementById('hint-label'),
                    hintLetter: document.getElementById('hint-letter'),
                    hintButton: document.getElementById('hint-button'),
                    startButton: document.getElementById('start-button'),
                    resetButton: document.getElementById('reset-button'),
                    sameButton: document.getElementById('same-button'),
                    differentButton: document.getElementById('different-button'),
                    sameJudgment: document.getElementById('same-judgment'),
                    differentJudgment: document.getElementById('different-judgment'),
                    levelText: document.getElementById('level-text'),
                    levelText2: document.getElementById('level-text2'),
                    levelText3: document.getElementById('level-text3'),
                    levelExampleContainer: document.getElementById('level-example-container'),
                    resultScore: document.getElementById('result-score'),
                    resultAccuracy: document.getElementById('result-accuracy'),
                    resultPoints: document.getElementById('result-points'),
                    replayButton: document.getElementById('replay-button'),
                    menuButton: document.getElementById('menu-button')
                };
            }
            
            setupEventListeners() {
                // „É¨„Éô„É´„Éú„Çø„É≥
                this.elements.levelButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (!this.isPlaying) {
                            this.setLevel(parseInt(btn.dataset.level));
                        }
                    });
                });

                // ÊôÇÈñì„Éú„Çø„É≥
                this.elements.timeButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (!this.isPlaying) {
                            this.setDisplayTime(parseInt(btn.dataset.time));
                        }
                    });
                });

                // ÂäπÊûúÈü≥„Éà„Ç∞„É´
                this.elements.soundToggle.checked = this.soundEnabled;
                this.elements.soundToggle.addEventListener('change', (e) => {
                    this.soundEnabled = e.target.checked;
                    localStorage.setItem('nback-sound-enabled', e.target.checked);
                });

                // „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ„Éà„Ç∞„É´
                const savedDarkMode = localStorage.getItem('nback-dark-mode') === 'true';
                this.elements.darkModeToggle.checked = savedDarkMode;
                if (savedDarkMode) {
                    document.body.classList.add('dark-mode');
                }
                this.elements.darkModeToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        document.body.classList.add('dark-mode');
                    } else {
                        document.body.classList.remove('dark-mode');
                    }
                    localStorage.setItem('nback-dark-mode', e.target.checked);
                });

                // „Ç≥„É≥„Éà„É≠„Éº„É´„Éú„Çø„É≥
                this.elements.startButton.addEventListener('click', () => this.toggleGame());
                this.elements.resetButton.addEventListener('click', () => this.resetGame());
                
                // ÂõûÁ≠î„Éú„Çø„É≥ - „ÇØ„É™„ÉÉ„ÇØ„Å®„Çø„ÉÉ„ÉÅ„ÅÆ‰∏°Êñπ„Å´ÂØæÂøú
                // ÂÖ±ÈÄö„ÅÆÂõûÁ≠îÂá¶ÁêÜ„Éï„É©„Ç∞„Åß„ÄÅ„Äá„Å®√ó„ÅÆ‰∏°ÊñπÊäº„Åó„ÇíÈò≤Ê≠¢
                let answerHandled = false;

                const handleSame = (e) => {
                    e.preventDefault();
                    if (answerHandled) return;
                    answerHandled = true;
                    this.handleAnswer(true);
                    setTimeout(() => answerHandled = false, 300);
                };

                const handleDifferent = (e) => {
                    e.preventDefault();
                    if (answerHandled) return;
                    answerHandled = true;
                    this.handleAnswer(false);
                    setTimeout(() => answerHandled = false, 300);
                };

                this.elements.sameButton.addEventListener('click', handleSame);
                this.elements.sameButton.addEventListener('touchend', handleSame);
                this.elements.differentButton.addEventListener('click', handleDifferent);
                this.elements.differentButton.addEventListener('touchend', handleDifferent);

                // Á≠î„Åà„ÇíË¶ã„Çã„Éú„Çø„É≥
                this.elements.hintButton.addEventListener('click', () => this.toggleHint());

                // ÁµêÊûúÁîªÈù¢„Éú„Çø„É≥
                this.elements.replayButton.addEventListener('click', () => {
                    this.showResult = false;
                    this.updateDisplay();
                    this.startGame();
                    // ÁîªÈù¢„ÅÆ‰∏ÄÁï™‰∏ã„Å´„Çπ„ÇØ„É≠„Éº„É´
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            window.scrollTo(0, document.body.scrollHeight);
                        });
                    });
                });
                this.elements.menuButton.addEventListener('click', () => {
                    this.showResult = false;
                    this.updateDisplay();
                });
                
                // „Ç≠„Éº„Éú„Éº„ÉâÊìç‰Ωú
                document.addEventListener('keydown', (e) => {
                    if (e.key === ' ') {
                        e.preventDefault();
                        this.toggleGame();
                    } else if (e.key.toLowerCase() === 'o' || e.key.toLowerCase() === 'j') {
                        this.handleAnswer(true);
                    } else if (e.key.toLowerCase() === 'x' || e.key.toLowerCase() === 'f') {
                        this.handleAnswer(false);
                    }
                });
            }
            
            setLevel(level) {
                this.level = level;
                this.updateLevelDisplay();
            }

            setDisplayTime(time) {
                this.letterDisplayTime = time;
                this.updateTimeDisplay();
            }

            updateLevelDisplay() {
                this.elements.levelButtons.forEach(btn => {
                    btn.classList.toggle('active', parseInt(btn.dataset.level) === this.level);
                });

                const levelTexts = {
                    1: '<span class="highlight">1„Å§Ââç</span>„Å®Âêå„Åò„Å™„Çâ„Äá„ÄÅÁï∞„Å™„Çå„Å∞√ó',
                    2: '<span class="highlight">2„Å§Ââç</span>„Å®Âêå„Åò„Å™„Çâ„Äá„ÄÅÁï∞„Å™„Çå„Å∞√ó',
                    3: '<span class="highlight">3„Å§Ââç</span>„Å®Âêå„Åò„Å™„Çâ„Äá„ÄÅÁï∞„Å™„Çå„Å∞√ó',
                    4: '<span class="highlight">4„Å§Ââç</span>„Å®Âêå„Åò„Å™„Çâ„Äá„ÄÅÁï∞„Å™„Çå„Å∞√ó'
                };
                this.elements.instructionText.innerHTML = levelTexts[this.level];
                this.elements.levelText.textContent = this.level;
                this.elements.levelText2.textContent = this.level;
                this.elements.levelText3.textContent = this.level;

                // Èõ£ÊòìÂ∫¶„Å´Âøú„Åò„ÅüÂõ≥Ëß£„ÇíË°®Á§∫
                this.updateLevelExample();
            }

            updateLevelExample() {
                const examples = {
                    1: `
                        <div style="background: var(--white); padding: 16px; border-radius: var(--border-radius); margin-bottom: 16px; border: 2px solid var(--primary-200);">
                            <div style="font-weight: 600; color: var(--primary-700); margin-bottom: 8px;">üìù ‰æãÔºö1-backÔºà1„Å§Ââç„Å®ÊØî„Åπ„ÇãÔºâ</div>
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 1.5rem;">
                                <div style="width: 60px; height: 60px; background: var(--gray-100); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700;">„ÅÇ</div>
                                <div style="color: var(--gray-400);">‚Üí</div>
                                <div style="width: 60px; height: 60px; background: var(--primary-100); border: 2px solid var(--primary-500); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--primary-700);">„ÅÇ</div>
                                <div style="margin-left: 8px; color: var(--success-600); font-weight: 700;">‚Üí „ÄáÔºàÂêå„ÅòÔºâ</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px; font-size: 1.5rem;">
                                <div style="width: 60px; height: 60px; background: var(--gray-100); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700;">„ÅÇ</div>
                                <div style="color: var(--gray-400);">‚Üí</div>
                                <div style="width: 60px; height: 60px; background: var(--primary-100); border: 2px solid var(--primary-500); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--primary-700);">„ÅÑ</div>
                                <div style="margin-left: 8px; color: var(--error-600); font-weight: 700;">‚Üí √óÔºàÈÅï„ÅÜÔºâ</div>
                            </div>
                        </div>
                    `,
                    2: `
                        <div style="background: var(--white); padding: 16px; border-radius: var(--border-radius); margin-bottom: 16px; border: 2px solid var(--warning-200);">
                            <div style="font-weight: 600; color: var(--warning-700); margin-bottom: 12px;">üìù ‰æãÔºö2-backÔºà2„Å§Ââç„Å®ÊØî„Åπ„ÇãÔºâ</div>
                            <div style="font-size: 0.9rem; color: var(--gray-600); margin-bottom: 12px; background: var(--warning-50); padding: 8px 12px; border-radius: 6px;">
                                ‚ö†Ô∏è ÊúÄÂàù„ÅÆ<strong style="color: var(--error-600);">2„Å§</strong>„ÅØ‰æãÈ°åÔºà„Éú„Çø„É≥ÈùûË°®Á§∫Ôºâ„ÄÇ<strong>3Áï™ÁõÆ„Åã„Çâ„Äá√ó„Éú„Çø„É≥„ÅåË°®Á§∫„Åï„ÇåÂõûÁ≠îÈñãÂßã</strong>ÔºÅ
                            </div>
                            <div style="margin-bottom: 16px; position: relative;">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 6px; margin-bottom: 8px; font-size: 1.3rem;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.75rem; color: var(--gray-500); margin-bottom: 4px;">‚ë†</div>
                                        <div style="width: 50px; height: 50px; background: var(--success-100); border: 2px solid var(--success-500); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.2rem; color: var(--success-700);">„ÅÇ</div>
                                    </div>
                                    <div style="color: var(--gray-400); margin-top: 20px;">‚Üí</div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.75rem; color: var(--gray-500); margin-bottom: 4px;">‚ë°</div>
                                        <div style="width: 50px; height: 50px; background: var(--gray-100); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.2rem;">„ÅÑ</div>
                                    </div>
                                    <div style="color: var(--gray-400); margin-top: 20px;">‚Üí</div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.75rem; color: var(--gray-500); margin-bottom: 4px;">‚ë¢</div>
                                        <div style="width: 50px; height: 50px; background: var(--success-100); border: 2px solid var(--success-500); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.2rem; color: var(--success-700);">„ÅÇ</div>
                                    </div>
                                </div>
                                <div style="text-align: center; margin-top: 8px; color: var(--success-600); font-weight: 700; font-size: 0.95rem;">
                                    ‚Üë „Åì„ÅÆ2„Å§„ÇíÊØî„Åπ„Çã ‚Üë<br>
                                    <span style="font-size: 1.1rem;">‚Üí Âêå„Åò„Å™„ÅÆ„Åß „Äá</span>
                                </div>
                            </div>
                            <div style="margin-bottom: 10px; position: relative;">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 6px; margin-bottom: 8px; font-size: 1.3rem;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.75rem; color: var(--gray-500); margin-bottom: 4px;">‚ë†</div>
                                        <div style="width: 50px; height: 50px; background: var(--error-100); border: 2px solid var(--error-500); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.2rem; color: var(--error-700);">„ÅÇ</div>
                                    </div>
                                    <div style="color: var(--gray-400); margin-top: 20px;">‚Üí</div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.75rem; color: var(--gray-500); margin-bottom: 4px;">‚ë°</div>
                                        <div style="width: 50px; height: 50px; background: var(--gray-100); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.2rem;">„ÅÑ</div>
                                    </div>
                                    <div style="color: var(--gray-400); margin-top: 20px;">‚Üí</div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.75rem; color: var(--gray-500); margin-bottom: 4px;">‚ë¢</div>
                                        <div style="width: 50px; height: 50px; background: var(--error-100); border: 2px solid var(--error-500); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.2rem; color: var(--error-700);">„ÅÜ</div>
                                    </div>
                                </div>
                                <div style="text-align: center; margin-top: 8px; color: var(--error-600); font-weight: 700; font-size: 0.95rem;">
                                    ‚Üë „Åì„ÅÆ2„Å§„ÇíÊØî„Åπ„Çã ‚Üë<br>
                                    <span style="font-size: 1.1rem;">‚Üí ÈÅï„ÅÜ„ÅÆ„Åß √ó</span>
                                </div>
                            </div>
                        </div>
                    `,
                    3: `
                        <div style="background: var(--white); padding: 16px; border-radius: var(--border-radius); margin-bottom: 16px; border: 2px solid var(--error-200);">
                            <div style="font-weight: 600; color: var(--error-700); margin-bottom: 12px;">üìù ‰æãÔºö3-backÔºà3„Å§Ââç„Å®ÊØî„Åπ„ÇãÔºâ</div>
                            <div style="font-size: 0.9rem; color: var(--gray-600); margin-bottom: 12px; background: var(--error-50); padding: 8px 12px; border-radius: 6px;">
                                ‚ö†Ô∏è ÊúÄÂàù„ÅÆ<strong style="color: var(--error-600);">3„Å§</strong>„ÅØ‰æãÈ°åÔºà„Éú„Çø„É≥ÈùûË°®Á§∫Ôºâ„ÄÇ<strong>4Áï™ÁõÆ„Åã„Çâ„Äá√ó„Éú„Çø„É≥„ÅåË°®Á§∫„Åï„ÇåÂõûÁ≠îÈñãÂßã</strong>ÔºÅ
                            </div>
                            <div style="margin-bottom: 16px; position: relative;">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 5px; margin-bottom: 0px; font-size: 1.2rem; position: relative;">
                                    <div style="text-align: center; position: relative;">
                                        <div style="font-size: 0.7rem; color: var(--gray-500); margin-bottom: 4px;">‚ë†</div>
                                        <div style="width: 45px; height: 45px; background: var(--success-100); border: 2px solid var(--success-500); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; color: var(--success-700);">„ÅÇ</div>
                                    </div>
                                    <div style="color: var(--gray-400); font-size: 0.9rem; margin-top: 18px;">‚Üí</div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.7rem; color: var(--gray-500); margin-bottom: 4px;">‚ë°</div>
                                        <div style="width: 45px; height: 45px; background: var(--gray-100); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem;">„ÅÑ</div>
                                    </div>
                                    <div style="color: var(--gray-400); font-size: 0.9rem; margin-top: 18px;">‚Üí</div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.7rem; color: var(--gray-500); margin-bottom: 4px;">‚ë¢</div>
                                        <div style="width: 45px; height: 45px; background: var(--gray-100); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem;">„ÅÜ</div>
                                    </div>
                                    <div style="color: var(--gray-400); font-size: 0.9rem; margin-top: 18px;">‚Üí</div>
                                    <div style="text-align: center; position: relative;">
                                        <div style="font-size: 0.7rem; color: var(--gray-500); margin-bottom: 4px;">‚ë£</div>
                                        <div style="width: 45px; height: 45px; background: var(--success-100); border: 2px solid var(--success-500); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; color: var(--success-700);">„ÅÇ</div>
                                    </div>
                                </div>
                                <div style="position: relative; margin-top: 5px; display: flex; justify-content: center;">
                                    <svg style="width: 250px; height: 30px; overflow: visible;">
                                        <path d="M 22.5 0 L 22.5 15 L 227.5 15 L 227.5 0" stroke="#059669" stroke-width="2" fill="none"/>
                                    </svg>
                                </div>
                                <div style="text-align: center; margin-top: 0px; color: var(--success-600); font-weight: 700; font-size: 0.9rem;">
                                    „Åì„ÅÆ2„Å§„ÇíÊØî„Åπ„Çã<br>
                                    <span style="font-size: 1.05rem;">‚Üí Âêå„Åò„Å™„ÅÆ„Åß „Äá</span>
                                </div>
                            </div>
                            <div style="margin-bottom: 10px; position: relative;">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 5px; margin-bottom: 0px; font-size: 1.2rem; position: relative;">
                                    <div style="text-align: center; position: relative;">
                                        <div style="font-size: 0.7rem; color: var(--gray-500); margin-bottom: 4px;">‚ë†</div>
                                        <div style="width: 45px; height: 45px; background: var(--error-100); border: 2px solid var(--error-500); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; color: var(--error-700);">„ÅÇ</div>
                                    </div>
                                    <div style="color: var(--gray-400); font-size: 0.9rem; margin-top: 18px;">‚Üí</div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.7rem; color: var(--gray-500); margin-bottom: 4px;">‚ë°</div>
                                        <div style="width: 45px; height: 45px; background: var(--gray-100); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem;">„ÅÑ</div>
                                    </div>
                                    <div style="color: var(--gray-400); font-size: 0.9rem; margin-top: 18px;">‚Üí</div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.7rem; color: var(--gray-500); margin-bottom: 4px;">‚ë¢</div>
                                        <div style="width: 45px; height: 45px; background: var(--gray-100); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem;">„ÅÜ</div>
                                    </div>
                                    <div style="color: var(--gray-400); font-size: 0.9rem; margin-top: 18px;">‚Üí</div>
                                    <div style="text-align: center; position: relative;">
                                        <div style="font-size: 0.7rem; color: var(--gray-500); margin-bottom: 4px;">‚ë£</div>
                                        <div style="width: 45px; height: 45px; background: var(--error-100); border: 2px solid var(--error-500); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; color: var(--error-700);">„Åà</div>
                                    </div>
                                </div>
                                <div style="position: relative; margin-top: 5px; display: flex; justify-content: center;">
                                    <svg style="width: 250px; height: 30px; overflow: visible;">
                                        <path d="M 22.5 0 L 22.5 15 L 227.5 15 L 227.5 0" stroke="#DC2626" stroke-width="2" fill="none"/>
                                    </svg>
                                </div>
                                <div style="text-align: center; margin-top: 0px; color: var(--error-600); font-weight: 700; font-size: 0.9rem;">
                                    „Åì„ÅÆ2„Å§„ÇíÊØî„Åπ„Çã<br>
                                    <span style="font-size: 1.05rem;">‚Üí ÈÅï„ÅÜ„ÅÆ„Åß √ó</span>
                                </div>
                            </div>
                        </div>
                    `,
                    4: ``
                };

                this.elements.levelExampleContainer.innerHTML = examples[this.level];
            }
            
            updateTimeDisplay() {
                this.elements.timeButtons.forEach(btn => {
                    btn.classList.toggle('active', parseInt(btn.dataset.time) === this.letterDisplayTime);
                });
            }

            toggleGame() {
                if (!this.isPlaying) {
                    this.startGame();
                } else if (this.isPaused) {
                    this.resumeGame();
                } else {
                    this.pauseGame();
                }
            }
            
            startGame() {
                this.clearTimers();
                
                this.isPlaying = true;
                this.isPaused = false;
                this.currentTrial = 0;
                this.letters = [];
                this.score = 0;
                this.correctCount = 0;
                this.totalAnswered = 0;
                this.feedback = '';
                this.showResult = false;
                this.canAnswer = false;
                
                this.updateDisplay();
                this.runTrial(1, []);
            }
            
            pauseGame() {
                this.isPaused = true;
                this.clearTimers();
                this.updateDisplay();
            }
            
            resumeGame() {
                this.isPaused = false;
                this.updateDisplay();

                if (this.showLetter) {
                    // Âè§„ÅÑ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Éè„É≥„Éâ„É©„Éº„ÇíÂâäÈô§
                    if (this.animationEndHandler) {
                        this.elements.letter.removeEventListener('animationend', this.animationEndHandler);
                    }

                    // Êñ∞„Åó„ÅÑ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Éè„É≥„Éâ„É©„Éº„ÇíÁôªÈå≤
                    this.animationEndHandler = () => {
                        if (!this.isPaused) {
                            this.elements.letter.classList.add('hidden');
                            this.showLetter = false;
                        }
                    };
                    this.elements.letter.addEventListener('animationend', this.animationEndHandler);
                }

                this.timerRef = setTimeout(() => {
                    this.runTrial(this.currentTrial + 1, this.letters);
                }, this.showLetter ? 3000 : 2500);
            }
            
            stopGame() {
                this.isPlaying = false;
                this.isPaused = false;
                this.clearTimers();
                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Éè„É≥„Éâ„É©„Éº„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
                if (this.animationEndHandler) {
                    this.elements.letter.removeEventListener('animationend', this.animationEndHandler);
                    this.animationEndHandler = null;
                }
                this.updateDisplay();
            }
            
            resetGame() {
                this.stopGame();
                this.score = 0;
                this.correctCount = 0;
                this.totalAnswered = 0;
                this.currentTrial = 0;
                this.currentLetter = '';
                this.showLetter = false;
                this.feedback = '';
                this.letters = [];
                this.canAnswer = false;
                this.showHint = false;
                this.lastAnsweredButton = null;
                this.lastAnswerCorrect = null;
                this.updateDisplay();
            }
            
            runTrial(trialNum, prevLetters) {
                if (this.isPaused) return;

                // ÈÄöÂ∏∏„É¢„Éº„ÉâÔºà„É¨„Éô„É´1-3ÔºâÔºö10Âïè„ÅßÁµÇ‰∫Ü
                // ÊøÄ„É†„Ç∫„É¢„Éº„ÉâÔºà„É¨„Éô„É´4ÔºâÔºö10Âïè‰ª•Èôç„ÅØÈñìÈÅï„Åà„Çã„Åæ„ÅßÁ∂ôÁ∂öÔºàÁµÇ‰∫ÜÊù°‰ª∂„Å™„ÅóÔºâ
                if (this.level !== 4 && trialNum > this.level + 10) {
                    this.isPlaying = false;
                    this.isPaused = false;
                    this.showLetter = false;
                    this.showResult = true;
                    this.updateDisplay();
                    return;
                }
                
                let newLetter;
                const shouldMatch = Math.random() < 0.5;
                
                if (trialNum > this.level && shouldMatch && prevLetters.length >= this.level) {
                    newLetter = prevLetters[prevLetters.length - this.level];
                } else {
                    newLetter = this.hiragana[Math.floor(Math.random() * this.hiragana.length)];
                }
                
                const newLetters = [...prevLetters, newLetter];
                
                this.currentTrial = trialNum;
                this.currentLetter = newLetter;
                this.showLetter = true;
                this.letters = newLetters;
                this.canAnswer = trialNum > this.level;
                this.feedback = '';
                
                this.updateDisplay();

                // Âè§„ÅÑ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Éè„É≥„Éâ„É©„Éº„ÇíÂâäÈô§
                if (this.animationEndHandler) {
                    this.elements.letter.removeEventListener('animationend', this.animationEndHandler);
                }

                // Êñ∞„Åó„ÅÑ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Éè„É≥„Éâ„É©„Éº„ÇíÁôªÈå≤
                this.animationEndHandler = () => {
                    if (!this.isPaused) {
                        this.elements.letter.classList.add('hidden');
                        this.showLetter = false;
                    }
                };
                this.elements.letter.addEventListener('animationend', this.animationEndHandler);

                this.timerRef = setTimeout(() => {
                    if (!this.isPaused) {
                        this.runTrial(trialNum + 1, newLetters);
                    }
                }, 3000);
            }
            
            handleAnswer(isMatch) {
                if (!this.canAnswer || !this.isPlaying || this.isPaused) return;

                // Âç≥Â∫ß„Å´ÂõûÁ≠î‰∏çÂèØ„Å´„Åó„Å¶„ÄÅ‰∫åÈáçÂõûÁ≠î„ÇíÂÆåÂÖ®„Å´Èò≤Ê≠¢
                this.canAnswer = false;

                const currentIndex = this.letters.length - 1;
                const compareIndex = currentIndex - this.level;
                const actualMatch = this.letters[currentIndex] === this.letters[compareIndex];
                const correct = isMatch === actualMatch;

                // ÂäπÊûúÈü≥„ÇíÈùûÂêåÊúü„ÅßÂÜçÁîüÔºà„É°„Ç§„É≥Âá¶ÁêÜ„Çí„Éñ„É≠„ÉÉ„ÇØ„Åó„Å™„ÅÑÔºâ
                if (this.soundEnabled) {
                    setTimeout(() => this.playSound(correct), 0);
                }

                // ÊñáÂ≠ó„ÅØÈÄöÂ∏∏ÈÄö„Çä„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅßÊ∂à„Åà„ÇãÔºà„Çø„Ç§„Éû„Éº„ÅØ„Åù„ÅÆ„Åæ„ÅæÔºâ

                if (correct) {
                    this.score += 10;
                    this.correctCount += 1;
                }

                this.totalAnswered += 1;
                // this.showHint = false; „ÇíÂâäÈô§„Åó„Å¶„ÄÅÁ≠î„ÅàË°®Á§∫„ÇíÁ∂ôÁ∂ö

                // Êäº„Åó„Åü„Éú„Çø„É≥„Å®Âà§ÂÆöÁµêÊûú„Çí‰øùÂ≠ò
                this.lastAnsweredButton = isMatch ? 'same' : 'different';
                this.lastAnswerCorrect = correct;
                this.feedback = 'showing';

                // Âà§ÂÆöÁµêÊûú„ÇíÂç≥Â∫ß„Å´Ë°®Á§∫
                this.showJudgmentImmediate();

                // Áµ±Ë®à„ÅÆ„ÅøÊõ¥Êñ∞
                this.elements.score.textContent = this.score;
                this.elements.correctCount.textContent = this.correctCount;
                const accuracy = this.totalAnswered > 0 ? (this.correctCount / this.totalAnswered * 100) : 0;
                this.elements.accuracy.textContent = accuracy.toFixed(1) + '%';

                // ÊøÄ„É†„Ç∫„É¢„Éº„ÉâÔºà„É¨„Éô„É´4ÔºâÔºö10Âïè‰ª•‰∏ä„Åß‰∏çÊ≠£Ëß£„Å™„ÇâÂç≥ÁµÇ‰∫Ü
                if (this.level === 4 && !correct && this.totalAnswered >= 10) {
                    // 1ÁßíÂæå„Å´ÁµêÊûúÁîªÈù¢„Å∏
                    setTimeout(() => {
                        this.clearTimers();
                        this.isPlaying = false;
                        this.isPaused = false;
                        this.showLetter = false;
                        this.showResult = true;
                        this.feedback = '';
                        this.lastAnsweredButton = null;
                        this.lastAnswerCorrect = null;
                        this.updateDisplay();
                    }, 1000);
                    return;
                }

                setTimeout(() => {
                    this.feedback = '';
                    this.lastAnsweredButton = null;
                    this.lastAnswerCorrect = null;
                    this.hideJudgment();
                    // canAnswer„ÅØÊ¨°„ÅÆÊñáÂ≠óË°®Á§∫ÊôÇ„Å´Ëá™ÂãïÁöÑ„Å´Ë®≠ÂÆö„Åï„Çå„Çã„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØÂ§âÊõ¥„Åó„Å™„ÅÑ
                }, 1000);
            }

            toggleHint() {
                if (!this.isPlaying || this.isPaused) return;
                this.showHint = !this.showHint;
                this.updateDisplay();
            }

            showJudgmentImmediate() {
                // Âà§ÂÆöÁµêÊûú„ÇíÂç≥Â∫ß„Å´Ë°®Á§∫ÔºàupdateDisplay()„ÇíÂëº„Å∞„Åö„Å´Áõ¥Êé•DOMÊìç‰ΩúÔºâ
                if (!this.lastAnsweredButton) return;

                const judgmentElement = this.lastAnsweredButton === 'same' ? this.elements.sameJudgment : this.elements.differentJudgment;
                const resultElement = judgmentElement.querySelector('.judgment-result');

                judgmentElement.classList.remove('hidden');
                resultElement.textContent = this.lastAnswerCorrect ? '„Äá' : '√ó';
                resultElement.className = `judgment-result ${this.lastAnswerCorrect ? 'correct' : 'incorrect'}`;

                const otherJudgment = this.lastAnsweredButton === 'same' ? this.elements.differentJudgment : this.elements.sameJudgment;
                otherJudgment.classList.add('hidden');
            }

            hideJudgment() {
                // Âà§ÂÆöË°®Á§∫„ÇíÈùûË°®Á§∫„Å´
                this.elements.sameJudgment.classList.add('hidden');
                this.elements.differentJudgment.classList.add('hidden');
            }

            clearTimers() {
                if (this.timerRef) {
                    clearTimeout(this.timerRef);
                    this.timerRef = null;
                }
                if (this.hideTimerRef) {
                    clearTimeout(this.hideTimerRef);
                    this.hideTimerRef = null;
                }
            }
            
            updateDisplay() {
                // ÁîªÈù¢„ÅÆË°®Á§∫Âàá„ÇäÊõø„Åà
                this.elements.gameScreen.classList.toggle('hidden', this.showResult);
                this.elements.resultScreen.classList.toggle('hidden', !this.showResult);

                if (this.showResult) {
                    const accuracy = this.totalAnswered > 0 ? (this.correctCount / this.totalAnswered * 100) : 0;
                    this.elements.resultScore.textContent = `${this.correctCount}/10ÂïèÊ≠£Ëß£`;
                    this.elements.resultAccuracy.textContent = `Ê≠£Á≠îÁéá: ${accuracy.toFixed(1)}%`;
                    this.elements.resultPoints.textContent = `„Çπ„Ç≥„Ç¢: ${this.score}ÁÇπ`;
                    return;
                }

                // „É¨„Éô„É´„Å®ÊôÇÈñìË®≠ÂÆöË°®Á§∫
                this.updateLevelDisplay();
                this.updateTimeDisplay();

                // Áµ±Ë®àË°®Á§∫
                this.elements.score.textContent = this.score;
                this.elements.correctCount.textContent = this.correctCount;
                const accuracy = this.totalAnswered > 0 ? (this.correctCount / this.totalAnswered * 100) : 0;
                this.elements.accuracy.textContent = accuracy.toFixed(1) + '%';
                
                // „Ç≤„Éº„É†„Ç®„É™„Ç¢Ë°®Á§∫
                if (this.showLetter) {
                    this.elements.letter.classList.remove('hidden');
                    // ÊñáÂ≠ó„ÇíË®≠ÂÆö
                    this.elements.letter.textContent = this.currentLetter;
                    // Ë°®Á§∫ÊôÇÈñì„Å´Âêà„Çè„Åõ„Å¶„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅÆÈï∑„Åï„ÇíË™øÊï¥
                    this.elements.letter.style.animationDuration = `${this.letterDisplayTime}ms`;
                    // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÂøÖ„Åö„É™„Çª„ÉÉ„Éà„Åó„Å¶ÂÜçÈñãÔºàÂêå„ÅòÊñáÂ≠ó„Åß„ÇÇË°®Á§∫„Åï„Çå„Çã„Çà„ÅÜ„Å´Ôºâ
                    this.elements.letter.style.animation = 'none';
                    this.elements.letter.offsetHeight; // „É™„Éï„É≠„ÉºÂº∑Âà∂
                    this.elements.letter.style.animation = '';
                }
                
                // Âà§ÂÆöÁµêÊûúË°®Á§∫ÔºàÊäº„Åó„Åü„Éú„Çø„É≥„ÅÆ‰∏ä„Å´„Ç™„Éº„Éê„Éº„É¨„Ç§Ôºâ
                if (this.feedback === 'showing' && this.lastAnsweredButton) {
                    // Êäº„Åó„Åü„Éú„Çø„É≥„ÅÆ‰∏ä„Å´Âà§ÂÆöÁµêÊûú„ÇíË°®Á§∫
                    const judgmentElement = this.lastAnsweredButton === 'same' ? this.elements.sameJudgment : this.elements.differentJudgment;
                    const resultElement = judgmentElement.querySelector('.judgment-result');

                    judgmentElement.classList.remove('hidden');
                    resultElement.textContent = this.lastAnswerCorrect ? '„Äá' : '√ó';
                    resultElement.className = `judgment-result ${this.lastAnswerCorrect ? 'correct' : 'incorrect'}`;

                    // „ÇÇ„ÅÜ‰∏ÄÊñπ„ÅÆ„Éú„Çø„É≥„ÅØÈùûË°®Á§∫
                    const otherJudgment = this.lastAnsweredButton === 'same' ? this.elements.differentJudgment : this.elements.sameJudgment;
                    otherJudgment.classList.add('hidden');
                } else {
                    // Âà§ÂÆöË°®Á§∫„ÇíÊ∂à„Åô
                    this.elements.sameJudgment.classList.add('hidden');
                    this.elements.differentJudgment.classList.add('hidden');
                }

                this.elements.startMessage.classList.toggle('hidden', this.isPlaying || this.showLetter || this.feedback);
                
                this.elements.trialInfo.classList.toggle('hidden', !this.isPlaying);
                const isExample = this.isPlaying && this.currentTrial > 0 && this.currentTrial <= this.level;

                if (this.isPlaying) {
                    const problemNumber = this.currentTrial > this.level ? this.currentTrial - this.level : 0;
                    this.elements.trialInfo.textContent = isExample ?
                        `‰æãÈ°å${this.currentTrial}` :
                        `${problemNumber}ÂïèÁõÆ`;
                    // ‰æãÈ°å„ÅÆÊôÇ„ÅØËÉåÊôØËâ≤„ÇíÂ§âÊõ¥
                    this.elements.gameArea.classList.toggle('example', isExample);
                } else {
                    this.elements.gameArea.classList.remove('example');
                }

                // „Ç≥„É≥„Éà„É≠„Éº„É´„Éú„Çø„É≥
                const startButtonText = this.elements.startButton.querySelector('span:last-child');
                startButtonText.textContent = !this.isPlaying ? 'ÈñãÂßã' : 
                    this.isPaused ? 'ÂÜçÈñã' : '‰∏ÄÊôÇÂÅúÊ≠¢';
                this.elements.startButton.className = `control-button ${!this.isPlaying ? 'start' :
                    this.isPaused ? 'resume' : 'pause'}`;

                // „É¨„Éô„É´„Éú„Çø„É≥„Å®ÊôÇÈñì„Éú„Çø„É≥
                this.elements.levelButtons.forEach(btn => {
                    btn.disabled = this.isPlaying;
                });
                this.elements.timeButtons.forEach(btn => {
                    btn.disabled = this.isPlaying;
                });

                // ÂõûÁ≠î„Éú„Çø„É≥
                const answerPaused = this.isPaused && this.canAnswer;
                const showingFeedback = (this.feedback === 'showing');

                // „Ç≤„Éº„É†ÈñãÂßãÂâç„Å®‰æãÈ°å„ÅÆÊôÇ„ÅØÂõûÁ≠î„Ç®„É™„Ç¢„ÇíË¶ã„Åà„Å™„Åè„Åô„ÇãÔºà„Çπ„Éö„Éº„Çπ„ÅØ‰øùÊåÅÔºâ
                const shouldHideAnswerArea = !this.isPlaying || isExample;
                const answerArea = document.querySelector('.answer-area');
                if (shouldHideAnswerArea) {
                    answerArea.style.visibility = 'hidden';
                    answerArea.style.pointerEvents = 'none';
                } else {
                    answerArea.style.visibility = 'visible';
                    answerArea.style.pointerEvents = 'auto';
                }

                // instruction-card„ÅÆË°®Á§∫Âàá„ÇäÊõø„Åà
                const instructionCard = document.querySelector('.instruction-card');
                if (this.isPlaying) {
                    if (isExample) {
                        // ‰æãÈ°å‰∏≠
                        if (this.currentTrial === 1) {
                            this.elements.instructionText.innerHTML = '„Åì„Çå„ÅåÊúÄÂàù„ÅÆÊñáÂ≠ó„Åß„Åô„ÄÇË¶ö„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                        } else {
                            this.elements.instructionText.innerHTML = `„Åì„Çå„Åå<span class="highlight">${this.currentTrial}Áï™ÁõÆ</span>„ÅÆÊñáÂ≠ó„Åß„Åô„ÄÇË¶ö„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
                        }
                    } else {
                        // ÂïèÈ°å‰∏≠
                        const levelTexts = {
                            1: '<span class="highlight">1„Å§Ââç</span>„Å®Âêå„Åò„Å≤„Çâ„Åå„Å™„Åß„Åô„ÅãÔºü',
                            2: '<span class="highlight">2„Å§Ââç</span>„Å®Âêå„Åò„Å≤„Çâ„Åå„Å™„Åß„Åô„ÅãÔºü',
                            3: '<span class="highlight">3„Å§Ââç</span>„Å®Âêå„Åò„Å≤„Çâ„Åå„Å™„Åß„Åô„ÅãÔºü',
                            4: '<span class="highlight">4„Å§Ââç</span>„Å®Âêå„Åò„Å≤„Çâ„Åå„Å™„Åß„Åô„ÅãÔºü'
                        };
                        this.elements.instructionText.innerHTML = levelTexts[this.level];
                    }
                    instructionCard.style.display = 'block';
                } else {
                    // „Ç≤„Éº„É†ÈñãÂßãÂâç„ÅØË™¨ÊòéÊñá
                    const levelTexts = {
                        1: '<span class="highlight">1„Å§Ââç</span>„Å®Âêå„Åò„Å™„Çâ„Äá„ÄÅÁï∞„Å™„Çå„Å∞√ó',
                        2: '<span class="highlight">2„Å§Ââç</span>„Å®Âêå„Åò„Å™„Çâ„Äá„ÄÅÁï∞„Å™„Çå„Å∞√ó',
                        3: '<span class="highlight">3„Å§Ââç</span>„Å®Âêå„Åò„Å™„Çâ„Äá„ÄÅÁï∞„Å™„Çå„Å∞√ó',
                        4: '<span class="highlight">4„Å§Ââç</span>„Å®Âêå„Åò„Å™„Çâ„Äá„ÄÅÁï∞„Å™„Çå„Å∞√ó'
                    };
                    this.elements.instructionText.innerHTML = levelTexts[this.level];
                    instructionCard.style.display = 'block';
                }

                if (!shouldHideAnswerArea) {
                    this.elements.sameButton.disabled = false;
                    this.elements.differentButton.disabled = false;
                    this.elements.sameButton.className = `answer-button same ${answerPaused ? 'paused' : ''} ${showingFeedback ? 'showing-feedback' : ''}`;
                    this.elements.differentButton.className = `answer-button different ${answerPaused ? 'paused' : ''} ${showingFeedback ? 'showing-feedback' : ''}`;
                }

                // Á≠î„Åà„ÇíË¶ã„Çã„Éú„Çø„É≥„Å®„Éí„É≥„ÉàË°®Á§∫
                // „Éú„Çø„É≥„ÅØ„Ç≤„Éº„É†‰∏≠„ÅØÂ∏∏„Å´Ë°®Á§∫
                this.elements.hintButton.classList.toggle('hidden', !this.isPlaying);

                // Á≠î„Åà„ÇíË°®Á§∫„Åô„Çã„ÅåON„ÅÆÊôÇ„ÅØÂ∏∏„Å´Ë°®Á§∫
                if (this.showHint && this.isPlaying && this.letters.length > this.level) {
                    const compareIndex = this.letters.length - 1 - this.level;
                    this.elements.hintLabel.textContent = `${this.level}ÂÄãÂâç„ÅÆÊñáÂ≠óÔºö`;
                    this.elements.hintLetter.textContent = this.letters[compareIndex];
                    this.elements.hintArea.classList.remove('hidden');
                } else {
                    this.elements.hintArea.classList.add('hidden');
                }
            }
        }
        
        // „Ç≤„Éº„É†ÈñãÂßã
        const game = new NBackGame();
    </script>
</body>
</html>
